<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IHWAP Scout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">IHWAP SCOUT</h1>

        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image">Analyze a field photo</label>
                <input type="file" name="image" id="image" class="form-control-file">
                <small class="form-text text-muted">
                    ‚ö†Ô∏è Please upload only field photos related to home weatherization inspections. Do not upload personal or unrelated images.
                </small>
            </div>

            <div class="form-group">
                <label for="chat_input">Ask Scout a question</label>
                <input type="text" name="chat_input" id="chat_input" class="form-control" placeholder="Ask about attic R-values, combustion safety, deferral rules...">
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-success">Submit</button>
                <button type="submit" name="clear_chat" value="1" class="btn btn-danger">Clear Chat</button>
            </div>
        </form>

        {% if chat_history %}
            <h3>Chat History</h3>
            <ul class="list-group mb-4">
                {% for entry in chat_history %}
                    <li class="list-group-item">
                        <strong>{{ "You" if entry.role == 'user' else "ü§ñ Scout" }}:</strong> {{ entry.content }}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {% if result %}
            <hr>
            <h3>FAAIE Result</h3>
            <p><strong>Scene Type Detected:</strong> {{ result.scene_type.capitalize() }}</p>
            <p><strong>Description:</strong> {{ result.description }}</p>
            <p><strong>Scout Thought:</strong> {{ result.scout_thought }}</p>
            <p><strong>Visible Elements:</strong> {{ result.visible_elements | join(", ") }}</p>

            <h4>Triggers:</h4>
            {% if result.matched_triggers %}
                <ul class="list-group">
                    {% for trigger in result.matched_triggers %}
                        <li class="list-group-item">
                            <strong>Trigger:</strong> {{ trigger.trigger }}<br>
                            <strong>Action:</strong> {{ trigger.response.action }}<br>
                            <strong>Reason:</strong> {{ trigger.response.reason }}<br>
                            <strong>Recommendation:</strong> {{ trigger.response.recommendation }}<br>
                            <strong>Citation:</strong> {{ trigger.response.source_policy }}<br>
                            <strong>Category:</strong> {{ trigger.response.category }}<br>
                            <strong>Visual Cue:</strong> {{ trigger.response.visual_cue }}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No relevant triggers detected for this scene type.</p>
            {% endif %}

            <div class="alert alert-warning mt-3">
                ‚ö†Ô∏è Automated analysis &mdash; Field verification by certified staff is required before any work or deferral.
            </div>

            <form method="POST" action="/download_report">
                <input type="hidden" name="result_data" value='{{ result | tojson | safe }}'>
                <button type="submit" class="btn btn-primary mt-3">Download PDF Report</button>
            </form>
        {% endif %}

        {% if image_path %}
            <hr>
            <h4>Uploaded Photo:</h4>
            <img src="{{ image_path }}" alt="Uploaded Field Photo" class="img-fluid">
        {% endif %}
    </div>
</body>
</html>

